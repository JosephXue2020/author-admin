# ES多表关联设计思路

- 采用每个（需要建立索引的）数据库表，建立一个索引。不使用视图、宽表的方式。

- 实现索引自动化创建：将需要建立索引的表格，设置tag说明es字段的类型；利用反射取到tag的值，自动将数据库表格结构体转化成mappings参数；然后根据这个mappings创建索引。

- 如同DB.AutoMigrate，初始化的时候建立ES索引。注意判断索引是否存在，不存在则创建。但是实际上，go-elasticsearch应该会判断，创建的index已存在是error不为nil的一种。

# ES与MySQL联动
- 最初想法是在连接层dao，将db和es封装起来，采用注册机制，对需要的表格双写。大部分已经实现，包括双写的时候，采用了gorm的事务策略，保证数据完整性。后来发现有问题：因为es和db的操作方式不同，很难协调；采用了大量的反射，性能肯定很差；相互之间紧密耦合，越看越难看。
- 思考再三之后，采取异步读写策略。即：让基于mysql的应用成为独立的、完整的http应用；让每个表格字段，都有一个timestamp的字段；es定时任务，从中获取更新的数据。
- 采取这种策略的基础：我们的数据量不多，撑死数万作者，几十万个条目；更新也不多；时效性要求不高，对于定时任务，可以定的长一点，比如10分钟。
- 好处：降低db和es的耦合度，即使删掉es，都不发生问题；models和indices可以呼应起来，结构比较优美。